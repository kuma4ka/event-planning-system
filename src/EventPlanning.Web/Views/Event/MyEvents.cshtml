@using EventPlanning.Application.Models
@using EventPlanning.Domain.Enums
@model PagedResult<EventDto>

@{
    ViewData["Title"] = "My Events";

    var currentViewType = ViewBag.CurrentViewType as string ?? "upcoming";
    var currentTypeEnum = ViewBag.CurrentType as EventType?;

}

<div class="container mt-5 mb-5">

    <div class="d-flex justify-content-between align-items-end dashboard-header mb-4">
        <div>
            <h1 class="dashboard-title display-5 mb-1" style="color: var(--text-main);">My Dashboard</h1>
            <p class="mb-0" style="color: var(--text-muted);">Track and manage your event journey.</p>
        </div>
        <a asp-controller="Event" asp-action="Create" class="btn btn-primary shadow-sm px-4 py-2">
            <i class="bi bi-plus-lg me-2"></i> Create Event
        </a>
    </div>

    <ul class="nav nav-tabs mb-4 border-bottom-0">
        <li class="nav-item">
            <a class="nav-link @(currentViewType == "upcoming" ? "active fw-bold border-bottom-0 border" : "border-0")"
                asp-controller="Event" asp-action="MyEvents" asp-route-viewType="upcoming"
                style="cursor: pointer; color: @(currentViewType == "upcoming" ? "var(--color-dark-teal)" : "var(--text-muted)"); background-color: @(currentViewType == "upcoming" ? "var(--bg-surface)" : "transparent");">
                📅 Upcoming
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(currentViewType == "past" ? "active fw-bold border-bottom-0 border" : "border-0")"
                asp-controller="Event" asp-action="MyEvents" asp-route-viewType="past"
                style="cursor: pointer; color: @(currentViewType == "past" ? "var(--color-dark-teal)" : "var(--text-muted)"); background-color: @(currentViewType == "past" ? "var(--bg-surface)" : "transparent");">
                📂 History
            </a>
        </li>
    </ul>

    <div class="mb-5">
        @{
            var fromDate = ViewBag.CurrentFrom as string != null ? DateTime.Parse(ViewBag.CurrentFrom) : (DateTime?)null;
            var toDate = ViewBag.CurrentTo as string != null ? DateTime.Parse(ViewBag.CurrentTo) : (DateTime?)null;
        }

        <vc:event-filter controller-name="Event" action-name="MyEvents" search-term="@ViewBag.CurrentSearch"
            type="@currentTypeEnum" from="@fromDate" to="@toDate" sort-order="@ViewBag.CurrentSort"
            view-type="@currentViewType" show-search="false">
        </vc:event-filter>
    </div>

    @if (!Model.Items.Any())
    {
        <div class="text-center py-5 rounded-3 border shadow-sm"
            style="background-color: var(--bg-surface); border-color: var(--border-light) !important;">
            <div class="mb-4">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width: 80px; height: 80px; background-color: var(--bg-body);">
                    <i class="bi @(currentViewType == "upcoming" ? "bi-calendar-event" : "bi-archive") fs-1 opacity-50"
                        style="color: var(--text-muted);"></i>
                </div>
            </div>
            <h3 class="fw-bold" style="color: var(--text-main);">
                @(currentViewType == "upcoming" ? "No upcoming events" : "No past events found")
            </h3>
            <p class="col-md-6 mx-auto" style="color: var(--text-muted);">
                @(currentViewType == "upcoming"
                    ? "You don't have any upcoming events planned. Ready to start?"
                    : "Your history is clean. Completed events will appear here.")
            </p>
            @if (currentViewType == "upcoming" && ViewBag.CurrentSearch == null)
            {
                <a asp-controller="Event" asp-action="Create" class="btn btn-primary mt-3 px-4">Create Event</a>
            }
            else
            {
                <a asp-controller="Event" asp-action="MyEvents" asp-route-viewType="@currentViewType"
                    class="btn btn-outline-secondary mt-3">Reset Filters</a>
            }
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0 fw-bold" style="color: var(--text-main);">
                    @(currentViewType == "upcoming" ? "Your Upcoming Events" : "Event History")
                </h4>
                <span class="badge border shadow-sm px-2 py-1 mt-1 fw-normal"
                    style="background-color: var(--bg-surface); color: var(--text-muted);">
                    @Model.TotalCount items
                </span>
            </div>

            <div class="d-flex rounded shadow-sm overflow-hidden" style="background-color: var(--bg-surface);">
                <button id="btnGridView" class="view-toggle-btn active" title="Grid View">
                    <i class="bi bi-grid-fill"></i>
                </button>
                <button id="btnListView" class="view-toggle-btn" title="List View">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
        </div>

        <div id="itemsContainer" class="row g-4">
            @foreach (var item in Model.Items)
            {
                var isPast = item.Date < DateTime.Now;

                <div class="col-md-6 col-lg-4 d-flex">
                    <div class="card h-100 w-100 shadow-sm border-0 hover-effect overflow-hidden"
                        style="background-color: var(--bg-surface);">

                        <div class="position-relative">
                            @if (!string.IsNullOrEmpty(item.VenueImageUrl))
                            {
                                <img src="@item.VenueImageUrl" class="card-img-top" style="height: 200px; object-fit: cover;"
                                    alt="@item.Name">
                            }
                            else
                            {
                                <div class="card-img-top w-100 d-flex align-items-center justify-content-center text-white"
                                    style="height: 200px; background: linear-gradient(135deg, var(--color-dark-teal), var(--color-air-force-blue));">
                                    <i class="bi bi-calendar-event fs-1 opacity-50"></i>
                                </div>
                            }

                            <div class="position-absolute top-0 end-0 m-3">
                                @if (isPast)
                                {
                                    <span class="badge bg-secondary shadow-sm">Completed</span>
                                }
                                else
                                {
                                    <span class="badge bg-success shadow-sm">Upcoming</span>
                                }
                            </div>
                        </div>

                        <div class="card-body d-flex flex-column p-4">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge border fw-normal"
                                    style="background-color: var(--bg-body); color: var(--text-main);">
                                    @item.Type.GetDisplayName()
                                </span>
                                <small class="fw-bold" style="color: var(--text-muted);">
                                    <i class="bi bi-calendar3 me-1"></i> @item.Date.ToString("MMM dd")
                                </small>
                            </div>

                            <h5 class="card-title fw-bold mb-1 fs-5">
                                <a asp-controller="Event" asp-action="Details" asp-route-id="@item.Id"
                                    class="text-decoration-none stretched-link" style="color: var(--text-main);">
                                    @item.Name
                                </a>
                            </h5>

                            <div class="small mb-3" style="color: var(--text-muted);">
                                <i class="bi bi-clock me-1"></i> @item.Date.ToString("HH:mm")
                            </div>

                            <div class="d-flex align-items-center small mb-3" style="color: var(--text-muted);">
                                <i class="bi bi-geo-alt-fill me-2 text-danger opacity-75"></i>
                                <span class="text-truncate">@item.VenueName</span>
                            </div>

                            <div class="mt-auto pt-3 border-top d-flex justify-content-end gap-2"
                                style="position: relative; z-index: 2; border-color: var(--border-light) !important;">

                                <button type="button" class="btn-action js-copy-link"
                                    data-url="@Url.Action("Details", "Event", new { id = item.Id }, Context.Request.Scheme)"
                                    title="Copy Link">
                                    <i class="bi bi-link-45deg"></i> Copy
                                </button>

                                @if (!isPast)
                                {
                                    <a asp-controller="Event" asp-action="Edit" asp-route-id="@item.Id"
                                        class="btn-action text-warning" title="Edit Event">
                                        <i class="bi bi-pencil-fill"></i> Edit
                                    </a>
                                }

                                <button type="button" class="btn-action text-danger" data-bs-toggle="modal"
                                    data-bs-target="#deleteModal" data-event-id="@item.Id" data-event-name="@item.Name"
                                    title="Delete Event">
                                    <i class="bi bi-trash-fill"></i> Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="mt-5">
            @if (Model.TotalPages > 1)
            {
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                            @if (Model.PageNumber > 1)
                            {
                                <a class="page-link" asp-controller="Event" asp-action="MyEvents"
                                    asp-route-page="@(Model.PageNumber - 1)" asp-route-viewType="@currentViewType"
                                    asp-route-sortOrder="@ViewBag.CurrentSort" asp-route-searchTerm="@ViewBag.CurrentSearch"
                                    asp-route-type="@ViewBag.CurrentType" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="ms-1">Previous</span>
                                </a>
                            }
                            else
                            {
                                <span class="page-link">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="ms-1">Previous</span>
                                </span>
                            }
                        </li>

                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            var pageIndex = i;

                            <li class="page-item @(pageIndex == Model.PageNumber ? "active" : "")">
                                @if (pageIndex == Model.PageNumber)
                                {
                                    <span class="page-link">@pageIndex</span>
                                }
                                else
                                {
                                    <a class="page-link" asp-controller="Event" asp-action="MyEvents" asp-route-page="@pageIndex"
                                        asp-route-viewType="@currentViewType" asp-route-sortOrder="@ViewBag.CurrentSort"
                                        asp-route-searchTerm="@ViewBag.CurrentSearch"
                                        asp-route-type="@ViewBag.CurrentType">@pageIndex</a>
                                }
                            </li>
                        }

                        <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                            @if (Model.PageNumber < Model.TotalPages)
                            {
                                <a class="page-link" asp-controller="Event" asp-action="MyEvents"
                                    asp-route-page="@(Model.PageNumber + 1)" asp-route-viewType="@currentViewType"
                                    asp-route-sortOrder="@ViewBag.CurrentSort" asp-route-searchTerm="@ViewBag.CurrentSearch"
                                    asp-route-type="@ViewBag.CurrentType" aria-label="Next">
                                    <span class="me-1">Next</span>
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            }
                            else
                            {
                                <span class="page-link">
                                    <span class="me-1">Next</span>
                                    <span aria-hidden="true">&raquo;</span>
                                </span>
                            }
                        </li>
                    </ul>
                </nav>
            }
        </div>
    }
</div>

<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true"
    data-url-template="@Url.Action("Delete", "Event", new { id = 0 })">

    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 overflow-hidden rounded-4" style="background-color: var(--bg-surface);">

            <div class="c-danger-header py-4"
                style="background-color: rgba(220, 53, 69, 0.1); text-align: center; border-bottom: 1px solid rgba(220, 53, 69, 0.1);">
                <i class="bi bi-exclamation-triangle fs-1 mb-2 d-block text-danger"></i>
                <h5 class="fw-bold mb-0 text-danger">Delete Event?</h5>
                <p class="mb-0 opacity-75 small text-danger">This action cannot be undone.</p>
            </div>

            <div class="modal-body p-4 text-center">
                <p class="mb-4" style="color: var(--text-muted);">
                    Are you sure you want to permanently delete <br />
                    <strong style="color: var(--text-main);" class="fs-5" id="modalEventName">Event Name</strong>?
                </p>

                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-light flex-grow-1 py-2 text-muted fw-bold border"
                        data-bs-dismiss="modal">
                        Cancel
                    </button>

                    <form id="deleteForm" method="post" class="flex-grow-1">
                        <button type="submit" class="btn btn-danger w-100 py-2 fw-bold">
                            Yes, Delete It
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>