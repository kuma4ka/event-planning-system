@using EventPlanning.Application.Models
@using EventPlanning.Domain.Enums
@model PagedResult<EventDto>

@{
    ViewData["Title"] = "My Events";

    var currentViewType = ViewBag.CurrentViewType as string ?? "upcoming";
    var currentTypeEnum = ViewBag.CurrentType as EventType?;

}

<div class="container mt-5 mb-5">

    <div class="d-flex justify-content-between align-items-end dashboard-header mb-4">
        <div>
            <h1 class="dashboard-title display-5 mb-1" style="color: var(--text-main);">My Dashboard</h1>
            <p class="mb-0" style="color: var(--text-muted);">Track and manage your event journey.</p>
        </div>
        <a asp-controller="Event" asp-action="Create" class="btn btn-primary shadow-sm px-4 py-2">
            <i class="bi bi-plus-lg me-2"></i> Create Event
        </a>
    </div>

    <ul class="nav nav-tabs mb-4 border-bottom-0">
        <li class="nav-item">
            <a class="nav-link @(currentViewType == "upcoming" ? "active fw-bold border-bottom-0 border" : "border-0")"
                asp-controller="Event" asp-action="MyEvents" asp-route-viewType="upcoming"
                style="cursor: pointer; color: @(currentViewType == "upcoming" ? "var(--color-dark-teal)" : "var(--text-muted)"); background-color: @(currentViewType == "upcoming" ? "var(--bg-surface)" : "transparent");">
                📅 Upcoming
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(currentViewType == "past" ? "active fw-bold border-bottom-0 border" : "border-0")"
                asp-controller="Event" asp-action="MyEvents" asp-route-viewType="past"
                style="cursor: pointer; color: @(currentViewType == "past" ? "var(--color-dark-teal)" : "var(--text-muted)"); background-color: @(currentViewType == "past" ? "var(--bg-surface)" : "transparent");">
                📂 History
            </a>
        </li>
    </ul>

    <div class="mb-5">
        @{
            var fromDate = ViewBag.CurrentFrom as string != null ? DateTime.Parse(ViewBag.CurrentFrom) : (DateTime?)null;
            var toDate = ViewBag.CurrentTo as string != null ? DateTime.Parse(ViewBag.CurrentTo) : (DateTime?)null;
        }

        <vc:event-filter controller-name="Event" action-name="MyEvents" search-term="@ViewBag.CurrentSearch"
            type="@currentTypeEnum" from="@fromDate" to="@toDate" sort-order="@ViewBag.CurrentSort"
            view-type="@currentViewType" show-search="false">
        </vc:event-filter>
    </div>

    @if (!Model.Items.Any())
    {
        <div class="text-center py-5 rounded-3 border shadow-sm"
            style="background-color: var(--bg-surface); border-color: var(--border-light) !important;">
            <div class="mb-4">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center"
                    style="width: 80px; height: 80px; background-color: var(--bg-body);">
                    <i class="bi @(currentViewType == "upcoming" ? "bi-calendar-event" : "bi-archive") fs-1 opacity-50"
                        style="color: var(--text-muted);"></i>
                </div>
            </div>
            <h3 class="fw-bold" style="color: var(--text-main);">
                @(currentViewType == "upcoming" ? "No upcoming events" : "No past events found")
            </h3>
            <p class="col-md-6 mx-auto" style="color: var(--text-muted);">
                @(currentViewType == "upcoming"
                    ? "You don't have any upcoming events planned. Ready to start?"
                    : "Your history is clean. Completed events will appear here.")
            </p>
            @if (currentViewType == "upcoming" && ViewBag.CurrentSearch == null)
            {
                <a asp-controller="Event" asp-action="Create" class="btn btn-primary mt-3 px-4">Create Event</a>
            }
            else
            {
                <a asp-controller="Event" asp-action="MyEvents" asp-route-viewType="@currentViewType"
                    class="btn btn-outline-secondary mt-3">Reset Filters</a>
            }
        </div>
    }
    else
    {
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0 fw-bold" style="color: var(--text-main);">
                    @(currentViewType == "upcoming" ? "Your Upcoming Events" : "Event History")
                </h4>
                <span class="badge border shadow-sm px-2 py-1 mt-1 fw-normal"
                    style="background-color: var(--bg-surface); color: var(--text-muted);">
                    @Model.TotalCount items
                </span>
            </div>

            <div class="d-flex rounded shadow-sm overflow-hidden" style="background-color: var(--bg-surface);">
                <button id="btnGridView" class="view-toggle-btn active" title="Grid View">
                    <i class="bi bi-grid-fill"></i>
                </button>
                <button id="btnListView" class="view-toggle-btn" title="List View">
                    <i class="bi bi-list-ul"></i>
                </button>
            </div>
        </div>

        <div id="itemsContainer" class="row g-4">
            @foreach (var item in Model.Items)
            {
                <partial name="Partials/_EventCard" model="item" />
            }
        </div>

        <div class="mt-5">
            @if (Model.TotalPages > 1)
            {
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                            @if (Model.PageNumber > 1)
                            {
                                <a class="page-link" asp-controller="Event" asp-action="MyEvents"
                                    asp-route-page="@(Model.PageNumber - 1)" asp-route-viewType="@currentViewType"
                                    asp-route-sortOrder="@ViewBag.CurrentSort" asp-route-searchTerm="@ViewBag.CurrentSearch"
                                    asp-route-type="@ViewBag.CurrentType" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="ms-1">Previous</span>
                                </a>
                            }
                            else
                            {
                                <span class="page-link">
                                    <span aria-hidden="true">&laquo;</span>
                                    <span class="ms-1">Previous</span>
                                </span>
                            }
                        </li>

                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            var pageIndex = i;

                            <li class="page-item @(pageIndex == Model.PageNumber ? "active" : "")">
                                @if (pageIndex == Model.PageNumber)
                                {
                                    <span class="page-link">@pageIndex</span>
                                }
                                else
                                {
                                    <a class="page-link" asp-controller="Event" asp-action="MyEvents" asp-route-page="@pageIndex"
                                        asp-route-viewType="@currentViewType" asp-route-sortOrder="@ViewBag.CurrentSort"
                                        asp-route-searchTerm="@ViewBag.CurrentSearch"
                                        asp-route-type="@ViewBag.CurrentType">@pageIndex</a>
                                }
                            </li>
                        }

                        <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                            @if (Model.PageNumber < Model.TotalPages)
                            {
                                <a class="page-link" asp-controller="Event" asp-action="MyEvents"
                                    asp-route-page="@(Model.PageNumber + 1)" asp-route-viewType="@currentViewType"
                                    asp-route-sortOrder="@ViewBag.CurrentSort" asp-route-searchTerm="@ViewBag.CurrentSearch"
                                    asp-route-type="@ViewBag.CurrentType" aria-label="Next">
                                    <span class="me-1">Next</span>
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            }
                            else
                            {
                                <span class="page-link">
                                    <span class="me-1">Next</span>
                                    <span aria-hidden="true">&raquo;</span>
                                </span>
                            }
                        </li>
                    </ul>
                </nav>
            }
        </div>
    }
</div>

<partial name="Partials/_DashboardModals" />